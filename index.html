<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivanta HR Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-blue: #0052CC;
            --secondary-blue: #0065FF;
            --dark-blue: #003D99;
            --light-blue: #E6F0FF;
            --text-primary: #172B4D;
            --text-secondary: #5E6C84;
            --border-color: #DFE1E6;
            --background: #FAFBFC;
            --white: #FFFFFF;
            --success: #00875A;
            --warning: #FF991F;
            --danger: #DE350B;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .navbar {
            background-color: var(--white);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--primary-blue);
            letter-spacing: -0.02em;
        }
        
        .navbar-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .btn-outline-primary {
            color: var(--primary-blue);
            border-color: var(--primary-blue);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-blue);
            border-color: var(--primary-blue);
        }
        
        .sidebar {
            background-color: var(--white);
            border-right: 1px solid var(--border-color);
            min-height: calc(100vh - 73px);
            padding: 0;
        }
        
        .sidebar .nav-link {
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9375rem;
        }
        
        .sidebar .nav-link:hover {
            background-color: var(--light-blue);
            color: var(--primary-blue);
        }
        
        .sidebar .nav-link.active {
            background-color: var(--light-blue);
            color: var(--primary-blue);
            border-left-color: var(--primary-blue);
        }
        
        .sidebar .nav-link i {
            width: 20px;
            margin-right: 0.75rem;
        }
        
        .main-content {
            padding: 2rem 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            background-color: var(--white);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background-color: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            font-size: 1.125rem;
            color: var(--text-primary);
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .stats-card {
            background-color: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .stats-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .login-container {
            min-height: 100vh;
            background-color: var(--background);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .login-card {
            background: var(--white);
            border-radius: 8px;
            padding: 2.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            max-width: 420px;
            width: 100%;
            border: 1px solid var(--border-color);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-header h2 {
            color: var(--primary-blue);
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }
        
        .login-header p {
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }
        
        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .form-control, .form-select {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.75rem;
            font-size: 0.9375rem;
            transition: border-color 0.2s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--light-blue);
            outline: none;
        }
        
        .btn-primary {
            background-color: var(--primary-blue);
            border: none;
            border-radius: 4px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            font-size: 0.9375rem;
            transition: background-color 0.2s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--dark-blue);
        }
        
        .btn-secondary {
            background-color: var(--text-secondary);
            border: none;
            border-radius: 4px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
        }
        
        .table {
            font-size: 0.9375rem;
        }
        
        .table thead th {
            background-color: var(--background);
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            padding: 1rem 0.75rem;
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .table tbody td {
            padding: 1rem 0.75rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table tbody tr:hover {
            background-color: var(--light-blue);
        }
        
        .badge {
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .badge-role {
            background-color: var(--light-blue);
            color: var(--primary-blue);
        }
        
        .badge-status-selected {
            background-color: #E3FCEF;
            color: var(--success);
        }
        
        .badge-status-pending {
            background-color: #FFF0B3;
            color: #974F0C;
        }
        
        .badge-status-joined {
            background-color: #E3FCEF;
            color: var(--success);
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .btn-action {
            background-color: var(--white);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            margin-right: 0.25rem;
        }
        
        .btn-action:hover {
            background-color: var(--background);
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }
        
        .hidden {
            display: none;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }
        
        .demo-info {
            background-color: var(--light-blue);
            border: 1px solid var(--primary-blue);
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1.5rem;
            font-size: 0.8125rem;
            color: var(--text-primary);
        }
        
        .alert {
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                min-height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .stats-card {
                padding: 1rem;
            }
            
            .stats-number {
                font-size: 2rem;
            }
            
            .table {
                font-size: 0.8125rem;
            }
            
            .card-header {
                padding: 1rem;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            .login-card {
                padding: 1.5rem;
            }
        }
        
        @media (max-width: 576px) {
            .table-responsive {
                overflow-x: auto;
            }
            
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h2>Trivanta HR Manager</h2>
                <p>Sign in to your account</p>
            </div>
            
            <div id="loginError" class="alert alert-danger hidden">
                Invalid credentials. Please try again.
            </div>
            
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" required placeholder="Enter username">
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" required placeholder="Enter password">
                </div>
                <div class="mb-4">
                    <label class="form-label">Portal Type</label>
                    <select id="userType" class="form-select">
                        <option value="vendor">Vendor Portal</option>
                        <option value="admin">Admin Portal</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    Sign In
                </button>
            </form>
            
            <div class="demo-info">
                <strong>Demo Credentials (Local Fallback):</strong><br>
                <strong>Admin:</strong> Siddhant / 102005<br>
                <strong>Vendor:</strong> testvendor / password
            </div>
        </div>
    </div>

    <div id="vendorPortal" class="hidden">
        <nav class="navbar">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="fas fa-users-cog"></i> Trivanta HR - Vendor Portal
                </span>
                <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                    <span class="navbar-text me-3">Welcome, <span id="vendorName"></span></span>
                    <button class="btn btn-outline-primary btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-2 col-md-3 sidebar">
                    <ul class="nav flex-column pt-3">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('vendorDashboard', event)">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('addCandidate', event)">
                                <i class="fas fa-user-plus"></i> Add Candidate
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('manageCandidates', event)">
                                <i class="fas fa-users"></i> Manage Candidates
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="col-lg-10 col-md-9 main-content">
                    <div id="vendorDashboard" class="section">
                        <h1 class="page-title">Dashboard</h1>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="vendorTotalCandidates">0</div>
                                    <div class="stats-label">Total Candidates</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="vendorSelectedCandidates">0</div>
                                    <div class="stats-label">Selected Candidates</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-card">
                                    <div class="stats-number" id="vendorPendingCandidates">0</div>
                                    <div class="stats-label">Pending Interviews</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="addCandidate" class="section hidden">
                        <h1 class="page-title">Add New Candidate</h1>
                        <div class="card">
                            <div class="card-body">
                                <form id="candidateForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Full Name</label>
                                            <input type="text" name="name" class="form-control" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Phone Number</label>
                                            <input type="tel" name="number" class="form-control" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Email</label>
                                            <input type="email" name="email" class="form-control" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Role</label>
                                            <select name="role" class="form-select" required>
                                                <option value="">Select Role</option>
                                                <option value="Fitter">Fitter</option>
                                                <option value="Helper">Helper</option>
                                                <option value="Site Supervisor">Site Supervisor</option>
                                                <option value="Welder">Welder</option>
                                                <option value="Parking Operator">Parking Operator</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Current Salary (₹)</label>
                                            <input type="number" name="currentSalary" class="form-control" required min="0">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Expected Salary (₹)</label>
                                            <input type="number" name="expectedSalary" class="form-control" required min="0">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Offered Salary (₹)</label>
                                            <input type="number" name="offeredSalary" class="form-control" min="0">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Total Experience (Years)</label>
                                            <input type="number" name="totalExperience" class="form-control" step="0.1" required min="0">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Relevant Experience (Years)</label>
                                            <input type="number" name="relevantExperience" class="form-control" step="0.1" required min="0">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Resume Attachment</label>
                                            <input type="file" name="resume" id="resumeFile" class="form-control" accept=".pdf,.doc,.docx">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Date of Interview</label>
                                            <input type="date" name="interviewDate" class="form-control">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Date of Selection</label>
                                            <input type="date" name="selectionDate" class="form-control">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Date of Joining</label>
                                            <input type="date" name="joiningDate" class="form-control">
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <button type="reset" class="btn btn-secondary me-2">Reset</button>
                                        <button type="submit" class="btn btn-primary">Add Candidate</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div id="manageCandidates" class="section hidden">
                        <h1 class="page-title">Manage Candidates</h1>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Role</th>
                                                <th>Phone</th>
                                                <th>Expected Salary</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                                 <tbody id="vendorCandidatesTable">
                                            <tr><td colspan="6" class="text-center">Loading candidates...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="adminPortal" class="hidden">
        <nav class="navbar">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="fas fa-users-cog"></i> Trivanta HR - Admin Portal
                </span>
                <div class="navbar-nav ms-auto d-flex flex-row align-items-center">
                    <span class="navbar-text me-3">Welcome, Administrator</span>
                    <button class="btn btn-outline-primary btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-2 col-md-3 sidebar">
                    <ul class="nav flex-column pt-3">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="showSection('adminDashboard', event)">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('allCandidates', event)">
                                <i class="fas fa-users"></i> All Candidates
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('manageVendors', event)">
                                <i class="fas fa-building"></i> Manage Vendors
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showSection('vendors', event)">
                                <i class="fas fa-chart-line"></i> Vendor Analytics
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="col-lg-10 col-md-9 main-content">
                    <div id="adminDashboard" class="section">
                        <h1 class="page-title">Dashboard</h1>
                        <div class="row">
                            <div class="col-lg-3 col-md-6">
                                <div class="stats-card">
                                    <div class="stats-number" id="adminTotalCandidates">0</div>
                                    <div class="stats-label">Total Candidates</div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="stats-card">
                                    <div class="stats-number" id="adminSelectedCandidates">0</div>
                                    <div class="stats-label">Selected</div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="stats-card">
                                    <div class="stats-number" id="adminActiveVendors">0</div>
                                    <div class="stats-label">Active Vendors</div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="stats-card">
                                    <div class="stats-number" id="adminPendingInterviews">0</div>
                                    <div class="stats-label">Pending Interviews</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="allCandidates" class="section hidden">
                        <h1 class="page-title">All Candidates</h1>
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>Candidate List</span>
                                <div>
                                    <select id="vendorFilter" class="form-select form-select-sm d-inline-block w-auto me-2" onchange="loadAllCandidates()">
                                        <option value="">All Vendors</option>
                                    </select>
                                    <select id="roleFilter" class="form-select form-select-sm d-inline-block w-auto" onchange="loadAllCandidates()">
                                        <option value="">All Roles</option>
                                        <option value="Fitter">Fitter</option>
                                        <option value="Helper">Helper</option>
                                        <option value="Site Supervisor">Site Supervisor</option>
                                        <option value="Welder">Welder</option>
                                        <option value="Parking Operator">Parking Operator</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Vendor</th>
                                                <th>Role</th>
                                                <th>Phone</th>
                                                <th>Expected Salary</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="adminCandidatesTable">
                                            <tr><td colspan="7" class="text-center">Loading candidates...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="manageVendors" class="section hidden">
                        <h1 class="page-title">Manage Vendors</h1>
                        
                        <div class="card mb-4">
                            <div class="card-header">Add New Vendor</div>
                            <div class="card-body">
                                <form id="addVendorForm">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Vendor Name</label>
                                            <input type="text" name="vendorName" class="form-control" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Username</label>
                                            <input type="text" name="vendorUsername" class="form-control" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Password</label>
                                            <input type="password" name="vendorPassword" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary">Add Vendor</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">All Vendors</div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Vendor Name</th>
                                                <th>Username</th>
                                                <th>Total Candidates</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="manageVendorsTable">
                                            <tr><td colspan="4" class="text-center">Loading vendors...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="vendors" class="section hidden">
                        <h1 class="page-title">Vendor Analytics</h1>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Vendor Name</th>
                                                <th>Total Candidates</th>
                                                <th>Selected</th>
                                                <th>Success Rate</th>
                                                <th>Last Activity</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vendorsTable">
                                            <tr><td colspan="5" class="text-center">Loading vendor analytics...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editCandidateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Candidate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editCandidateForm">
                        <input type="hidden" id="editCandidateId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Full Name</label>
                                <input type="text" id="editName" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" id="editNumber" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" id="editEmail" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Role</label>
                                <select id="editRole" class="form-select" required>
                                    <option value="Fitter">Fitter</option>
                                    <option value="Helper">Helper</option>
                                    <option value="Site Supervisor">Site Supervisor</option>
                                    <option value="Welder">Welder</option>
                                    <option value="Parking Operator">Parking Operator</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Current Salary (₹)</label>
                                <input type="number" id="editCurrentSalary" class="form-control" required min="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Expected Salary (₹)</label>
                                <input type="number" id="editExpectedSalary" class="form-control" required min="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Offered Salary (₹)</label>
                                <input type="number" id="editOfferedSalary" class="form-control" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date of Selection</label>
                                <input type="date" id="editSelectionDate" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date of Joining</label>
                                <input type="date" id="editJoiningDate" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateCandidate()">Update Candidate</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables (will be populated from Firestore)
        let currentUser = null;
        let localCandidates = []; // Fallback/cache
        let localVendors = []; // Fallback/cache

        // Utility functions (remains the same)
        function sanitizeInput(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function validateSalary(current, expected, offered) {
            if (expected < current) {
                alert('Expected salary should be greater than or equal to current salary');
                return false;
            }
            if (offered && offered < expected) {
                if (!confirm('Offered salary is less than expected salary. Continue?')) {
                    return false;
                }
            }
            return true;
        }

        function getStatus(selectionDate, joiningDate) {
            if (joiningDate) return 'Joined';
            if (selectionDate) return 'Selected';
            return 'Interview Pending';
        }

        function getStatusBadgeClass(status) {
            const statusMap = {
                'Joined': 'badge-status-joined',
                'Selected': 'badge-status-selected',
                'Interview Pending': 'badge-status-pending'
            };
            return statusMap[status] || 'badge-status-pending';
        }
    </script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
        // 🔥 ADDED FIRESTORE IMPORTS
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDT2e0j-Nvd3weMZaCI7rCb2vJ3DwCdIrk",
            authDomain: "dazzlohr.firebaseapp.com",
            projectId: "dazzlohr",
            storageBucket: "dazzlohr.firebasestorage.app",
            messagingSenderId: "997294562239",
            appId: "1:997294562239:web:e49d02aecd7b0aa99b9f0a",
            measurementId: "G-PCN9GGF3DY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        // 🔥 INITIALIZE FIRESTORE
        const db = getFirestore(app);

        // --- Data Fetching Utilities ---
        
        async function fetchAllVendors() {
            try {
                const vendorsCol = collection(db, "vendors");
                const vendorSnapshot = await getDocs(vendorsCol);
                window.localVendors = vendorSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                return window.localVendors;
            } catch (error) {
                console.error("Error fetching vendors:", error);
                // Fallback to initial demo data if Firestore fails
                window.initializeDemoData();
                return window.localVendors;
            }
        }

        async function fetchAllCandidates() {
            try {
                const candidatesCol = collection(db, "candidates");
                const candidateSnapshot = await getDocs(candidatesCol);
                window.localCandidates = candidateSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                return window.localCandidates;
            } catch (error) {
                console.error("Error fetching candidates:", error);
                // Fallback to initial demo data if Firestore fails
                window.initializeDemoData();
                return window.localCandidates;
            }
        }

        // --- Login and navigation functions (Updated) ---
        
        window.handleLogin = async function(event) {
            if (event) {
                event.preventDefault();
            }
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const userType = document.getElementById('userType').value;
            
            document.getElementById('loginError').classList.add('hidden');
            
            if (userType === 'admin' && username === 'Siddhant' && password === '102005') {
                window.currentUser = { type: 'admin', name: 'Administrator' };
                await window.fetchAllVendors(); // Pre-fetch data for admin portal
                window.showPortal('admin');
            } else if (userType === 'vendor') {
                const vendors = await window.fetchAllVendors();
                const vendor = vendors.find(v => v.username === username && v.password === password);
                
                if (vendor) {
                    window.currentUser = { type: 'vendor', id: vendor.id, name: vendor.name };
                    document.getElementById('vendorName').textContent = vendor.name;
                    window.showPortal('vendor');
                } else {
                    window.showLoginError();
                }
            } else {
                window.showLoginError();
            }
        }
        
        window.showPortal = async function(type) {
            document.getElementById('loginScreen').classList.add('hidden');
            if (type === 'admin') {
                document.getElementById('adminPortal').classList.remove('hidden');
                await window.loadAdminDashboard();
            } else {
                document.getElementById('vendorPortal').classList.remove('hidden');
                await window.loadVendorDashboard();
            }
        }

        // --- Dashboard functions (Updated) ---

        window.loadVendorDashboard = async function() {
            const allCandidates = await window.fetchAllCandidates();
            const vendorCandidates = allCandidates.filter(c => c.vendorId === window.currentUser.id);
            const selectedCount = vendorCandidates.filter(c => c.status === 'Selected' || c.status === 'Joined').length;
            const pendingCount = vendorCandidates.filter(c => c.status === 'Interview Pending').length;
            
            document.getElementById('vendorTotalCandidates').textContent = vendorCandidates.length;
            document.getElementById('vendorSelectedCandidates').textContent = selectedCount;
            document.getElementById('vendorPendingCandidates').textContent = pendingCount;
        }

        window.loadAdminDashboard = async function() {
            const allCandidates = await window.fetchAllCandidates();
            const allVendors = await window.fetchAllVendors();
            
            const selectedCount = allCandidates.filter(c => c.status === 'Selected' || c.status === 'Joined').length;
            const pendingCount = allCandidates.filter(c => c.status === 'Interview Pending').length;
            const activeVendorsCount = new Set(allCandidates.map(c => c.vendorId)).size;
            
            document.getElementById('adminTotalCandidates').textContent = allCandidates.length;
            document.getElementById('adminSelectedCandidates').textContent = selectedCount;
            document.getElementById('adminActiveVendors').textContent = activeVendorsCount;
            document.getElementById('adminPendingInterviews').textContent = pendingCount;
            
            // Populate vendor filter
            const vendorFilter = document.getElementById('vendorFilter');
            vendorFilter.innerHTML = '<option value="">All Vendors</option>';
            // Get unique vendor names from the candidates data, or use all vendor names
            const uniqueVendorNames = [...new Set(allVendors.map(v => v.name))];
            uniqueVendorNames.forEach(vendor => {
                vendorFilter.innerHTML += `<option value="${window.sanitizeInput(vendor)}">${window.sanitizeInput(vendor)}</option>`;
            });
        }

        // --- Candidate management functions (Updated) ---

        window.loadVendorCandidates = async function() {
            const allCandidates = await window.fetchAllCandidates();
            const vendorCandidates = allCandidates.filter(c => c.vendorId === window.currentUser.id);
            const tableBody = document.getElementById('vendorCandidatesTable');
            
            if (vendorCandidates.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No candidates found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = vendorCandidates.map(candidate => `
                <tr>
                    <td><strong>${window.sanitizeInput(candidate.name)}</strong></td>
                    <td><span class="badge badge-role">${window.sanitizeInput(candidate.role)}</span></td>
                    <td>${window.sanitizeInput(candidate.number)}</td>
                    <td>₹${candidate.expectedSalary ? candidate.expectedSalary.toLocaleString() : 'N/A'}</td>
                    <td><span class="badge ${window.getStatusBadgeClass(candidate.status)}">${window.sanitizeInput(candidate.status)}</span></td>
                    <td>
                        <button class="btn btn-action btn-sm" onclick="editCandidate('${candidate.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-action btn-sm" onclick="downloadCandidatePDF('${candidate.id}')" title="Download PDF">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-action btn-sm" onclick="deleteCandidate('${candidate.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.loadAllCandidates = async function() {
            const tableBody = document.getElementById('adminCandidatesTable');
            let filteredCandidates = await window.fetchAllCandidates();
            
            const vendorFilter = document.getElementById('vendorFilter').value;
            const roleFilter = document.getElementById('roleFilter').value;
            
            if (vendorFilter) {
                filteredCandidates = filteredCandidates.filter(c => c.vendorName === vendorFilter);
            }
            if (roleFilter) {
                filteredCandidates = filteredCandidates.filter(c => c.role === roleFilter);
            }
            
            if (filteredCandidates.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No candidates found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = filteredCandidates.map(candidate => `
                <tr>
                    <td><strong>${window.sanitizeInput(candidate.name)}</strong></td>
                    <td>${window.sanitizeInput(candidate.vendorName)}</td>
                    <td><span class="badge badge-role">${window.sanitizeInput(candidate.role)}</span></td>
                    <td>${window.sanitizeInput(candidate.number)}</td>
                    <td>₹${candidate.expectedSalary ? candidate.expectedSalary.toLocaleString() : 'N/A'}</td>
                    <td><span class="badge ${window.getStatusBadgeClass(candidate.status)}">${window.sanitizeInput(candidate.status)}</span></td>
                    <td>
                        <button class="btn btn-action btn-sm" onclick="downloadCandidatePDF('${candidate.id}')" title="Download PDF">
                            <i class="fas fa-download"></i>
                        </button>
                        ${candidate.resumeURL ? `<a href="${candidate.resumeURL}" target="_blank" class="btn btn-action btn-sm" title="View Resume"><i class="fas fa-file"></i></a>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        // --- Candidate CRUD operations (Updated) ---

        window.editCandidate = async function(candidateId) {
            const allCandidates = await window.fetchAllCandidates();
            const candidate = allCandidates.find(c => c.id === candidateId);
            if (!candidate) return;
            
            document.getElementById('editCandidateId').value = candidate.id;
            document.getElementById('editName').value = candidate.name;
            document.getElementById('editNumber').value = candidate.number;
            document.getElementById('editEmail').value = candidate.email;
            document.getElementById('editRole').value = candidate.role;
            document.getElementById('editCurrentSalary').value = candidate.currentSalary;
            document.getElementById('editExpectedSalary').value = candidate.expectedSalary;
            document.getElementById('editOfferedSalary').value = candidate.offeredSalary || '';
            document.getElementById('editSelectionDate').value = candidate.selectionDate || '';
            document.getElementById('editJoiningDate').value = candidate.joiningDate || '';
            
            new bootstrap.Modal(document.getElementById('editCandidateModal')).show();
        }

        window.updateCandidate = async function() {
            const candidateId = document.getElementById('editCandidateId').value;
            const candidateDocRef = doc(db, "candidates", candidateId);

            const currentSalary = parseInt(document.getElementById('editCurrentSalary').value);
            const expectedSalary = parseInt(document.getElementById('editExpectedSalary').value);
            const offeredSalary = document.getElementById('editOfferedSalary').value ? parseInt(document.getElementById('editOfferedSalary').value) : null;
            const selectionDate = document.getElementById('editSelectionDate').value || null;
            const joiningDate = document.getElementById('editJoiningDate').value || null;

            if (!window.validateSalary(currentSalary, expectedSalary, offeredSalary)) {
                return;
            }

            const updatedData = {
                name: document.getElementById('editName').value.trim(),
                number: document.getElementById('editNumber').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                role: document.getElementById('editRole').value,
                currentSalary: currentSalary,
                expectedSalary: expectedSalary,
                offeredSalary: offeredSalary,
                selectionDate: selectionDate,
                joiningDate: joiningDate,
                status: window.getStatus(selectionDate, joiningDate)
            };
            
            try {
                await updateDoc(candidateDocRef, updatedData);
                bootstrap.Modal.getInstance(document.getElementById('editCandidateModal')).hide();
                await window.loadVendorCandidates();
                await window.loadVendorDashboard();
                alert('Candidate updated successfully!');
            } catch (error) {
                console.error("Error updating candidate: ", error);
                alert('Failed to update candidate. See console for details.');
            }
        }

        window.deleteCandidate = async function(candidateId) {
            if (confirm('Are you sure you want to delete this candidate?')) {
                const candidateDocRef = doc(db, "candidates", candidateId);
                try {
                    await deleteDoc(candidateDocRef);
                    await window.loadVendorCandidates();
                    await window.loadVendorDashboard();
                    alert('Candidate deleted successfully!');
                } catch (error) {
                    console.error("Error deleting candidate: ", error);
                    alert('Failed to delete candidate. See console for details.');
                }
            }
        }

        // --- PDF generation (Updated to use fetched data) ---

        window.downloadCandidatePDF = async function(candidateId) {
            const allCandidates = await window.fetchAllCandidates();
            const candidate = allCandidates.find(c => c.id === candidateId);
            if (!candidate) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(0, 82, 204);
            doc.text('Trivanta HR Manager', 20, 25);
            
            doc.setFontSize(14);
            doc.setTextColor(23, 43, 77);
            doc.text('Candidate Profile', 20, 35);
            
            // Table data
            const tableData = [
                ['Field', 'Value'],
                ['Full Name', candidate.name],
                ['Phone Number', candidate.number],
                ['Email', candidate.email],
                ['Role', candidate.role],
                ['Current Salary', `₹${candidate.currentSalary ? candidate.currentSalary.toLocaleString() : 'N/A'}`],
                ['Expected Salary', `₹${candidate.expectedSalary ? candidate.expectedSalary.toLocaleString() : 'N/A'}`],
                ['Offered Salary', candidate.offeredSalary ? `₹${candidate.offeredSalary.toLocaleString()}` : 'Not Set'],
                ['Total Experience', `${candidate.totalExperience} Years`],
                ['Relevant Experience', `${candidate.relevantExperience} Years`],
                ['Interview Date', candidate.interviewDate || 'Not Scheduled'],
                ['Selection Date', candidate.selectionDate || 'Not Selected'],
                ['Joining Date', candidate.joiningDate || 'Not Joined'],
                ['Status', candidate.status],
                ['Vendor Name', candidate.vendorName]
            ];
            
            doc.autoTable({
                head: [tableData[0]],
                body: tableData.slice(1),
                startY: 45,
                styles: { fontSize: 10, cellPadding: 5 },
                headStyles: { fillColor: [0, 82, 204], textColor: 255 },
                alternateRowStyles: { fillColor: [250, 251, 252] }
            });
            
            // Footer
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text('Generated by Trivanta HR Manager', 20, pageHeight - 10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, pageHeight - 5);
            
            doc.save(`${candidate.name.replace(/[^a-z0-9]/gi, '_')}_Profile.pdf`);
        }

        // --- Vendor management functions (Updated) ---

        window.loadManageVendorsTable = async function() {
            const allVendors = await window.fetchAllVendors();
            const allCandidates = await window.fetchAllCandidates();
            const tableBody = document.getElementById('manageVendorsTable');
            
            if (allVendors.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No vendors found. Add your first vendor above.</td></tr>';
                return;
            }
            
            tableBody.innerHTML = allVendors.map(vendor => {
                const vendorCandidates = allCandidates.filter(c => c.vendorId === vendor.id);
                return `
                    <tr>
                        <td><strong>${window.sanitizeInput(vendor.name)}</strong></td>
                        <td>${window.sanitizeInput(vendor.username)}</td>
                        <td><span class="badge badge-role">${vendorCandidates.length}</span></td>
                        <td>
                            <button class="btn btn-action btn-sm" onclick="deleteVendor('${vendor.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        window.deleteVendor = async function(vendorId) {
            if (confirm('Are you sure you want to delete this vendor? This will NOT delete their associated candidates.')) {
                const vendorDocRef = doc(db, "vendors", vendorId);
                try {
                    await deleteDoc(vendorDocRef);
                    await window.loadManageVendorsTable();
                    alert('Vendor deleted successfully!');
                } catch (error) {
                    console.error("Error deleting vendor: ", error);
                    alert('Failed to delete vendor. See console for details.');
                }
            }
        }

        window.loadVendorsTable = async function() {
            const allVendors = await window.fetchAllVendors();
            const allCandidates = await window.fetchAllCandidates();
            const tableBody = document.getElementById('vendorsTable');
            
            const vendorStats = allVendors.map(vendor => {
                const vendorCandidates = allCandidates.filter(c => c.vendorId === vendor.id);
                const selected = vendorCandidates.filter(c => c.status === 'Selected' || c.status === 'Joined').length;
                const totalCandidates = vendorCandidates.length;
                const successRate = totalCandidates > 0 ? ((selected / totalCandidates) * 100).toFixed(1) : '0';
                
                // Firestore timestamps are objects; this approximation uses the local data for "last activity"
                const lastActivity = totalCandidates > 0 ? 
                    new Date(Math.max(...vendorCandidates.map(c => new Date(c.createdAt)))).toLocaleDateString() : 
                    'Never';
                
                return {
                    ...vendor,
                    total: totalCandidates,
                    selected: selected,
                    successRate: successRate,
                    lastActivity: lastActivity
                };
            });
            
            tableBody.innerHTML = vendorStats.map(vendor => `
                <tr>
                    <td><strong>${window.sanitizeInput(vendor.name)}</strong></td>
                    <td><span class="badge badge-role">${vendor.total}</span></td>
                    <td><span class="badge badge-status-selected">${vendor.selected}</span></td>
                    <td>${vendor.successRate}%</td>
                    <td>${vendor.lastActivity}</td>
                </tr>
            `).join('');
        }

        // --- Event listeners (Updated to use async functions and Firestore) ---

        document.addEventListener('DOMContentLoaded', function() {
            // FIREBASE NOTE: The local initialization data is moved to a function
            // to be called only if Firestore data fetch fails (as a fallback).
            window.initializeDemoData = function() {
                // Original demo data kept for initial setup/fallback
                window.localVendors = [
                    { id: 'testvendor', name: 'Test Vendor Company', username: 'testvendor', password: 'password' },
                    { id: 'vendor2', name: 'ABC Solutions', username: 'abcsolutions', password: 'abc123' }
                ];
                window.localCandidates = [
                    { id: '1', vendorId: 'testvendor', vendorName: 'Test Vendor Company', name: 'John Doe', number: '9876543210', email: 'john.doe@email.com', role: 'Fitter', currentSalary: 25000, expectedSalary: 30000, offeredSalary: 32000, totalExperience: 3.5, relevantExperience: 2.5, resumeURL: null, interviewDate: '2024-01-15', selectionDate: '2024-01-20', joiningDate: null, status: 'Selected', createdAt: new Date().toISOString() },
                    { id: '2', vendorId: 'testvendor', vendorName: 'Test Vendor Company', name: 'Jane Smith', number: '9876543211', email: 'jane.smith@email.com', role: 'Welder', currentSalary: 22000, expectedSalary: 28000, offeredSalary: null, totalExperience: 2.0, relevantExperience: 1.5, resumeURL: null, interviewDate: '2024-01-25', selectionDate: null, joiningDate: joiningDate,
                    status: window.getStatus(selectionDate, joiningDate),
                    createdAt: new Date().toISOString() // Using ISO string for simple timestamp
                };
                
                try {
                    const docRef = await addDoc(collection(db, "candidates"), candidate);
                    // Add the Firestore-generated ID to the local cache/log
                    window.localCandidates.push({ id: docRef.id, ...candidate }); 
                    alert('Candidate added successfully!');
                    this.reset();
                    await window.loadVendorDashboard();
                } catch (error) {
                    console.error("Error adding document: ", error);
                    alert('Failed to add candidate. See console for details.');
                }
            });
            
            // Add vendor form submission (Updated for Firestore)
            document.getElementById('addVendorForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const username = formData.get('vendorUsername').trim();
                
                const allVendors = await window.fetchAllVendors();
                
                if (allVendors.find(v => v.username === username)) {
                    alert('Username already exists. Please choose a different username.');
                    return;
                }
                
                const vendorData = {
                    name: formData.get('vendorName').trim(),
                    username: username,
                    password: formData.get('vendorPassword').trim()
                };
                
                try {
                    // Use username as document ID for easy lookup, but ensure uniqueness first
                    const vendorDocRef = doc(db, "vendors", username); 
                    await setDoc(vendorDocRef, vendorData);

                    // Re-fetch and update UI
                    await window.fetchAllVendors(); 
                    alert('Vendor added successfully!');
                    this.reset();
                    await window.loadManageVendorsTable();
                } catch (error) {
                    console.error("Error adding vendor: ", error);
                    alert('Failed to add vendor. See console for details.');
                }
            });
        });
        
        // Exporting functions to the global scope so they can be called from onclick attributes
        window.showLoginError = function() { document.getElementById('loginError').classList.remove('hidden'); }
    </script>
</body>
</html>